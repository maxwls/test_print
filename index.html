<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>设计器</title>
    <link href="styles.css" rel="stylesheet" />
  </head>
  <body>
    <script src="./script/jquery-1.11.2.min.js" type="text/javascript"></script>

    <script
      src="./build/stimulsoft.reports.engine.src.js"
      type="text/javascript"
    ></script>
    <script
      src="./build/stimulsoft.reports.export.src.js"
      type="text/javascript"
    ></script>
    <script src="./build/osp.viewer.src.js" type="text/javascript"></script>
    <script src="./build/osp.designer.src.js" type="text/javascript"></script>
    <!-- <script src="../build/osp.reports.engine.pack.js"></script>
        <script src="../build/osp.reports.export.pack.js"></script>
        <script src="../build/osp.viewer.pack.js" type="text/javascript"></script>
        <script src="../build/osp.designer.pack.js" type="text/javascript"></script> -->
    <script type="text/javascript">
      window.$ = null; //测试时避免window对象干扰
      Stimulsoft.Base.StiLicense.key =
        "6vJhGtLLLz2GNviWmUTrhSqnOItdDwjBylQzQcAOiHkeCyu4tQ/fHMz14+aX8heK5fPWPOh9GhOJWHXzBWfWkku5KP" +
        "ChSipMnMVPpqTvfJS7sIxjF/cxhVrUvULFfcxcaCxjU9i6mZsEDM7BO+haAK3b38ycQVY0MQLANLSx5MZDk64iZY3P" +
        "Tch8l8h+G4eHK2bcztaqjQsdfficwLSgadjyB/6byFWPUQGIUZIicm7hdluCKxvRMJ9LksBxlgcJSnXQYm5RJxoibg" +
        "yH5H5tzHyms+PF3ePcgpoXlcRotDn6IyefrvWPGiKKcia/HRIsoXRM8lDeOueiFgQ29UyMwGQ2In/3iwD9vdZ9ag1A" +
        "wsjwO/i95q9QMe5Vl8qh7DaGaICQUN41fCgSX2UcS9wNzX8pu1/YUfQ0Nr3ZrE2GTnLDWiBBMGxCbmTmny0xJRMmIJ" +
        "zSO0o//fqTfSKvGTZqquNLg4+YrXxUWDMos04Xka1BO4DkZVnN33tUwINu44cuzUrRVXe/BvmphpnEEskGGbmtT86z" +
        "GSdRjirhJWqtsV4PaPlsFATWMafoe3/+EA1a";
      // 获取url参数
      function getUrlParam(name) {
        var reg = new RegExp("(^|&)" + name + "=([^&]*)(&|jQuery)"); //构造一个含有目标参数的正则表达式对象
        var r = window.location.search.substr(1).match(reg); //匹配目标参数
        if (r != null) return decodeURI(r[2]);
        return null; //返回参数值
      }
      var lang = getUrlParam("lang") == null ? "en_US" : getUrlParam("lang");
      Stimulsoft.Base.Localization.StiLocalization.addLocalizationFile(
        "./Localization/" + lang + ".xml",
        false,
        lang
      );
      Stimulsoft.Base.Localization.StiLocalization.cultureName = lang;

      var report = new Stimulsoft.Report.StiReport();
      var options = new Stimulsoft.Designer.StiDesignerOptions();
      options.ospData = {
        jQuery: window.jQuery,
        beginLoadReport: function () {
          console.log(12345);
        },
      };
      options.height = "100%";
      options.appearance.showReportTree = true;
      options.appearance.showTooltips = true;
      options.appearance.showTooltipsHelp = false;
      options.appearance.allowChangeWindowTitle = true;
      options.appearance.showPropertiesGrid = true;
      options.appearance.showSaveDialog = false;
      options.appearance.allowChangeWindowTitle = false;
      options.appearance.showLocalization = false;
      options.toolbar.showFileMenu = true;
      options.toolbar.showSetupToolboxButton = true;
      options.toolbar.showInsertButton = true;
      options.toolbar.showLayoutButton = true;
      options.toolbar.showFileMenuSaveAs = true;
      options.toolbar.showFileMenuAbout = false;
      options.toolbar.showFileMenuHelp = false;

      options.bands.showTable = true;
      options.components.showPanel = true;
      var designer = new Stimulsoft.Designer.StiDesigner(options);
      designer.onSaveReport = function (args) {
        report = args.report;
        showSaveModel();
      };
      // jQuery('#StiDesigner_Viewer_JsViewerMainPanel').remove();
      // Stimulsoft.System.StiError.showError("Some message after saving", true);

      var FORM_BH =
          getUrlParam("FORM_BH") == null ? "" : getUrlParam("FORM_BH"),
        FORM_MC = getUrlParam("FORM_MC") == null ? "" : getUrlParam("FORM_MC"),
        PF_TYPE = getUrlParam("PF_TYPE") == null ? "" : getUrlParam("PF_TYPE"),
        F_NOTE = getUrlParam("F_NOTE") == null ? "" : getUrlParam("F_NOTE"),
        MDL_ID = getUrlParam("MDL_ID") == null ? "" : getUrlParam("MDL_ID"),
        isreact = getUrlParam("isreact") == null ? "0" : "1", // '0'代表GWT 不传,'1'代表react
        chuser = getUrlParam("chuser") == null ? "" : getUrlParam("chuser"), //修改人
        DefDictKey =
          getUrlParam("DefDictKey") == null ? "" : getUrlParam("DefDictKey");
      EditRefDict =
        getUrlParam("EditRefDict") == null ? "" : getUrlParam("EditRefDict");
      multiLanguage =
        getUrlParam("MultiLanguage") == null
          ? "false"
          : getUrlParam("MultiLanguage");

      var flag = FORM_BH == "" ? false : true; //新建:false  编辑:true

      /*---------预加载默认数据源begin--------*/
      var DefDict = null;
      //如果不存在DefDictKey默认数据源key，则直接调用加载格式文件
      if (DefDictKey != "") {
        if (typeof window["indexedDB"] !== "undefined") {
          linkIndexDB();
        } else {
          //如果不支持，也直接加载格式文件。
          getMrt();
          showTips("你的浏览器不支持indexedDB，无法加载默认数据源");
        }
      } else {
        getMrt();
      }
      var request, db;
      function linkIndexDB() {
        request = window.indexedDB.open("GWTindexedDB", "1");
        request.onerror = function (event) {
          showTips("你的浏览器不支持indexedDB，无法加载默认数据源");
        };
        request.onsuccess = function (e) {
          db = request.result;
          getDefaultDataBase(db, DefDictKey, loadDataBase);
        };
      }

      // 根据key值从indexDB获取数据JSON
      function getDefaultDataBase(db, key, callback) {
        // 获取单条数据
        var transaction = db.transaction(["ROStore"]);
        var store = transaction.objectStore("ROStore");
        var res = store.get(key);
        res.onsuccess = function (e) {
          callback(JSON.parse(e.target.result));
        };
      }

      // 加载数据源
      function loadDataBase(data) {
        //如果是新建，则直接追加
        DefDict = data;
        if (!flag) {
          designer.report = report;
          designer.jsObject.options.commands[0] = {
            command: "OpenDictionary",
            base64Data: data,
          };
          designer.jsObject.ExecuteCommandFromStack();
        } else {
          //编辑的话直接加载格式文件，然后判断是否替换
          getMrt();
        }
      }
      /*---------预加载默认数据源end-----------*/

      /*-------如果是编辑模式加载格式文件begin------*/
      function getMrt() {
        //如果是新建则不加载mrt文件
        if (!flag) {
          designer.report = report;
        } else {
          jQuery(".number input").val(FORM_BH),
            jQuery(".name input").val(FORM_MC);
          var params =
            '{"params": {"PrintID": "' +
            FORM_BH +
            '","MultiLanguage": "' +
            multiLanguage +
            '"}}';
          jQuery.ajax({
            type: "POST",
            url: "../../../rest/print/loadmrt",
            async: true,
            processData: false,
            contentType: "application/json",
            data: params,
            success: function (data) {
              if (data.code == 0) {
                var mrtjson = data.data.mrtjson;
                //如果是编辑，且强制刷新数据源是1，且默认数据源不为空，则替换格式上的数据源
                if (flag && EditRefDict == "1" && DefDict != null) {
                  mrtjson.Dictionary = DefDict;
                }
                report.load(mrtjson);
                designer.report = report;
              } else {
                showTips(data.message);
              }
            },
            error: function (xhr, type, errorThrown) {
              showTips("模板加载失败，请检查网络！");
            },
          });
        }
      }
      /*-------如果是编辑模式加载格式文件end------*/
      // 关闭元数据加载弹窗
      jQuery(".model .loadDictionary").on(
        "click",
        ".title i, .cancel i",
        function () {
          hideLoadDictionary();
        }
      );
      function hideLoadDictionary() {
        jQuery(".model").hide();
        jQuery(".loadDictionary").hide();
      }
      jQuery("body").on("paste", function (e) {
        if (jQuery(".loadDictionary").css("display") === "block") {
          jQuery(".loadDictionary .url input").focus();
        }
      });

      // 加载字典json
      jQuery(".model .loadDictionary").on(
        "click",
        ".preservation i",
        function () {
          var jsonURL = jQuery(".loadDictionary .url input").val();
          if (jsonURL == "") {
          } else {
            hideLoadDictionary();
            jQuery.ajax({
              type: "POST",
              url: jsonURL,
              async: false,
              processData: false,
              contentType: "application/json",
              success: function (data) {
                if (data.code == 0) {
                  designer.jsObject.options.commands[0] = {
                    command: "OpenDictionary",
                    base64Data: data.data,
                    // commandGuid: "a0e681c58f9747f494c760747e141fc2"
                  };
                  designer.jsObject.ExecuteCommandFromStack();
                } else {
                  showTips(data.message);
                }
              },
              error: function (xhr, type, errorThrown) {
                hideLoadDictionary();
                showTips("数据导入出错！");
              },
            });
          }
        }
      );

      // 显示提示弹窗
      function showTips(txt) {
        jQuery(".tips .content").text(txt);
        jQuery(".model").show();
        jQuery(".tips").show();
      }
      // 隐藏提示弹窗
      function hideTips() {
        jQuery(".tips .content").text("");
        jQuery(".model").hide();
        jQuery(".tips").hide();
      }
      jQuery(".tips .title i, .tips .btn span").on("click", function () {
        hideTips();
      });

      // 显示保存弹窗
      function showSaveModel(isSaveAs) {
        if (isSaveAs == true) {
          flag = false;
          jQuery(".number input").val(""), jQuery(".name input").val("");
        } else if (FORM_BH == "") {
          flag = false;
          jQuery(".number input").val(""), jQuery(".name input").val("");
        } else {
          flag = true;
          jQuery(".number input").val(FORM_BH),
            jQuery(".name input").val(FORM_MC);
        }
        if (flag) {
          jQuery(".number input").attr("disabled", true);
        } else {
          jQuery(".number input").attr("disabled", false);
        }
        jQuery(".model").show();
        jQuery(".savainfo").show();
      }
      // 编号未输入提示
      function showNumError(txt) {
        jQuery(".savainfo .numbererror").text(txt);
        jQuery(".savainfo .numbererror").css("visibility", "visible");
      }
      // 名称未输入提示
      function showNameError(txt) {
        jQuery(".savainfo .nameerror").text(txt);
        jQuery(".savainfo .nameerror").css("visibility", "visible");
      }
      // 取消保存框所有提示
      function hideAllEoor() {
        jQuery(".savainfo .numbererror").text("");
        jQuery(".savainfo .nameerror").text("");
        jQuery(".savainfo .error").css("visibility", "hidden");
      }
      // 保存弹窗input获取焦点,隐藏错误提示
      jQuery(".savainfo").on("input", "input", function () {
        hideAllEoor();
      });
      // 取消保存弹窗
      jQuery(".model .savainfo").on(
        "click",
        ".close i, .cancel i",
        function () {
          jQuery(".model").hide();
          jQuery(".savainfo").hide();
        }
      );
      // 点击保存
      jQuery(".model").on("click", ".savainfo .preservation i", function () {
        var PrintID = jQuery(".number input").val().trim(),
          PrintName = jQuery(".name input").val().trim();
        var isAllowSave = true;
        if (PrintID == "") {
          showNumError("请输入编号");
          isAllowSave = false;
        } else if (PrintID.length > 30) {
          showNumError("编号长度不得超过30，当前长度:" + PrintID.length);
          isAllowSave = false;
        }
        if (PrintName == "") {
          showNameError("请输入名称");
          isAllowSave = false;
        } else if (PrintName.length > 60) {
          showNameError("名称长度不得超过60，当前长度:" + PrintName.length);
          isAllowSave = false;
        }
        if (isAllowSave == false) {
          return false;
        }
        if (flag) {
          savemrt(PrintID, PrintName);
        } else {
          checkmrt(PrintID, PrintName);
        }
      });
      // 检测ID是否重复
      function checkmrt(PrintID, PrintName) {
        var params = '{"params": {"PrintID": "' + PrintID + '"}}';
        jQuery.ajax({
          type: "POST",
          url: "../../../rest/print/checkmrt",
          async: true,
          processData: false,
          contentType: "application/json",
          data: params,
          success: function (data) {
            if (data.code == 0) {
              savemrt(PrintID, PrintName);
            } else {
              showNumError(data.message);
            }
          },
          error: function (xhr, type, errorThrown) {
            showNumError("编号检查失败，请检查网络！");
          },
        });
      }
      // 保存mrt
      function savemrt(PrintID, PrintName) {
        var jsonString = report.saveToJsonString();
        FORM_BH = PrintID;
        FORM_MC = PrintName;
        var params;
        if (isreact == "1") {
          //修改为只传修改人 有修改人时，如果没有模板，创建人==修改人，时间==当前时间
          //有修改人时，如果有模板，更新修改人与修改时间
          params =
            '{"printData": ' +
            jsonString +
            ',"params": {"PrintType": "' +
            PF_TYPE +
            '","chuser": "' +
            chuser +
            '","PrintID": "' +
            PrintID +
            '","PrintName": "' +
            PrintName +
            '","PrintNote": "","MultiLanguage": "' +
            multiLanguage +
            '","businessID":"' +
            businessID +
            '"}}';
        } else {
          params =
            '{"printData": ' +
            jsonString +
            ',"params": {"PrintType": "' +
            PF_TYPE +
            '","PrintID": "' +
            PrintID +
            '","PrintName": "' +
            PrintName +
            '","PrintNote": "","MultiLanguage": "' +
            multiLanguage +
            '","businessID":"' +
            businessID +
            '"}}';
        }
        jQuery.ajax({
          type: "POST",
          url: "../../../rest/print/savemrt",
          async: true,
          processData: false,
          contentType: "application/json",
          data: params,
          success: function (data) {
            jQuery(".savainfo").hide();
            showTips(data.message);
          },
          error: function (xhr, type, errorThrown) {
            showTips("保存失败，请检查网络！");
          },
        });
      }
    </script>
  </body>
</html>
